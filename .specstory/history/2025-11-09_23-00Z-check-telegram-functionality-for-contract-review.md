<!-- Generated by SpecStory -->

# Check telegram functionality for contract review (2025-11-09 23:00Z)

_**User (2025-11-09 13:44Z)**_

pleas check the telegram functionality.. dont send the report, just make sure once we get the contract review, there is a telergram msg saying: "contract reviewed". telegram credentials are setup in .env as 

TELEGRAM_BOT_TOKEN and TELEGRAM_BOSS_CHAT_ID



---

_**Assistant**_



---


Checking the Telegram functionality and ensuring a "contract reviewed" message is sent after review completion. Examining the relevant files.


---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---



---


Checking tests for Telegram usage:


---



---



---


Updating the code to send a simple "contract reviewed" message and use `TELEGRAM_BOSS_CHAT_ID`:


---

<details><summary>Edit file: app/config.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -10,5 +10,5 @@
      google_drive_folder: str = "Contract_Reviews"
      telegram_bot_token: str | None = None
-     telegram_chat_id: str | None = None
+     telegram_boss_chat_id: str | None = None
      report_storage_dir: str = "reports"
  
```

</details>

---

<details><summary>Edit file: app/telegram_client.py</summary>

undefined

**Chunk 1**
Lines added: 25, lines removed: undefined

```diff
@@ -18,4 +18,29 @@
          self.settings = get_settings()
  
+     async def notify_review_complete(self) -> TelegramDispatchResult:
+         """Send a simple notification that contract review is complete."""
+         if not self.settings.telegram_bot_token or not self.settings.telegram_boss_chat_id:
+             message = "Telegram credentials missing; skipped notification."
+             logger.info(message)
+             logger.info("To enable Telegram, set TELEGRAM_BOT_TOKEN and TELEGRAM_BOSS_CHAT_ID in .env and restart the server.")
+             return TelegramDispatchResult(sent=False, error=message)
+ 
+         payload = {
+             "chat_id": self.settings.telegram_boss_chat_id,
+             "text": "contract reviewed",
+         }
+         url = TELEGRAM_URL_TEMPLATE.format(token=self.settings.telegram_bot_token)
+ 
+         try:
+             async with httpx.AsyncClient(timeout=30) as client:
+                 response = await client.post(url, json=payload)
+                 response.raise_for_status()
+                 data = response.json()
+                 message_id = data.get("result", {}).get("message_id")
+                 return TelegramDispatchResult(sent=True, message_id=str(message_id))
+         except Exception as exc:  # pylint: disable=broad-except
+             logger.error("Telegram notification failed: %s", exc)
+             return TelegramDispatchResult(sent=False, error=str(exc))
+ 
      async def send_summary(
          self,
```

**Chunk 2**
Lines added: 3, lines removed: 3

```diff
@@ -25,13 +50,13 @@
          drive_link: str,
      ) -> TelegramDispatchResult:
-         if not self.settings.telegram_bot_token or not self.settings.telegram_chat_id:
+         if not self.settings.telegram_bot_token or not self.settings.telegram_boss_chat_id:
              message = "Telegram credentials missing; skipped notification."
              logger.info(message)
-             logger.info("To enable Telegram, set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID in .env and restart the server.")
+             logger.info("To enable Telegram, set TELEGRAM_BOT_TOKEN and TELEGRAM_BOSS_CHAT_ID in .env and restart the server.")
              return TelegramDispatchResult(sent=False, error=message)
  
          message_body = self._build_message(contract_title, evaluation, drive_link)
          payload = {
-             "chat_id": self.settings.telegram_chat_id,
+             "chat_id": self.settings.telegram_boss_chat_id,
              "text": message_body,
              "parse_mode": "Markdown",
```

</details>

---

<details><summary>Edit file: app/review_service.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 5

```diff
@@ -35,9 +35,5 @@
          drive_link = self.drive.upload_report(report.local_path)
          report.drive_link = drive_link
-         telegram_result = await self.notifier.send_summary(
-             evaluation=evaluation,
-             contract_title=contract_title,
-             drive_link=drive_link,
-         )
+         telegram_result = await self.notifier.notify_review_complete()
          return evaluation, report, drive_link, telegram_result
  
```

</details>

---



---


Updating tests to use the new method and environment variable:


---

Read file: undefined

---

Read file: undefined

---

Read file: undefined

---



---


Updating tests to use the new method and environment variable:


---

<details><summary>Edit file: tests/conftest.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -118,5 +118,5 @@
      monkeypatch.setenv("OPENROUTER_API_KEY", "")
      monkeypatch.setenv("TELEGRAM_BOT_TOKEN", "")
-     monkeypatch.setenv("TELEGRAM_CHAT_ID", "")
+     monkeypatch.setenv("TELEGRAM_BOSS_CHAT_ID", "")
      monkeypatch.setenv("GOOGLE_DRIVE_FOLDER", "Test_Contract_Reviews")
      monkeypatch.setenv("REPORT_STORAGE_DIR", "test_reports")
```

</details>

---

<details><summary>Edit file: tests/test_api.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -89,5 +89,5 @@
          from app.models import TelegramDispatchResult
  
-         with patch("app.review_service.TelegramNotifier.send_summary", new_callable=AsyncMock) as mock_telegram:
+         with patch("app.review_service.TelegramNotifier.notify_review_complete", new_callable=AsyncMock) as mock_telegram:
              mock_telegram.return_value = TelegramDispatchResult(sent=False, error="Credentials missing")
  
```

**Chunk 2**
Lines added: 1, lines removed: 1

```diff
@@ -154,5 +154,5 @@
          from app.models import TelegramDispatchResult
  
-         with patch("app.review_service.TelegramNotifier.send_summary", new_callable=AsyncMock) as mock_telegram:
+         with patch("app.review_service.TelegramNotifier.notify_review_complete", new_callable=AsyncMock) as mock_telegram:
              mock_telegram.return_value = TelegramDispatchResult(sent=False, error="Credentials missing")
  
```

</details>

---



---


Checking for linting errors:


---



---



---


Verifying the changes are correct:


---

Read file: undefined

---

Read file: undefined

---



---


## Changes Made:

1. **Updated `app/config.py`**: Changed `telegram_chat_id` to `telegram_boss_chat_id` to match your `.env` variable name.

2. **Updated `app/telegram_client.py`**: 
   - Added a new method `notify_review_complete()` that sends a simple "contract reviewed" message
   - Updated `send_summary()` to also use `telegram_boss_chat_id` (kept for potential future use)

3. **Updated `app/review_service.py`**: Changed the call from `send_summary()` to `notify_review_complete()` so it only sends the simple notification.

4. **Updated tests**: Modified test files to use the new method name and environment variable.

When a contract review completes, the system will send a Telegram message with the text "contract reviewed" to the chat ID specified in `TELEGRAM_BOSS_CHAT_ID`. The report is not sent via Telegram; only the notification message is sent.

The functionality is ready to use once you have `TELEGRAM_BOT_TOKEN` and `TELEGRAM_BOSS_CHAT_ID` set in your `.env` file.

---

_**User (2025-11-09 13:44Z)**_

ook it works, now lets send that telegram message with "Boss, there is a new contract review.

Mention if there are critical issues and just add a quick bullet point about it. Then just say how many clauses need review and how many are compliant. 

---

_**Assistant**_



---


Updating the Telegram notification to include a summary with critical issues and clause counts. Checking the evaluation model structure:


---

Read file: undefined

---



---


Updating the Telegram notification to include the evaluation summary:


---

<details><summary>Edit file: app/telegram_client.py</summary>

undefined

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -18,6 +18,6 @@
          self.settings = get_settings()
  
-     async def notify_review_complete(self) -> TelegramDispatchResult:
-         """Send a simple notification that contract review is complete."""
+     async def notify_review_complete(self, *, evaluation: ChecklistEvaluation) -> TelegramDispatchResult:
+         """Send a notification that contract review is complete with summary."""
          if not self.settings.telegram_bot_token or not self.settings.telegram_boss_chat_id:
              message = "Telegram credentials missing; skipped notification."
```

**Chunk 2**
Lines added: 2, lines removed: 1

```diff
@@ -26,7 +26,8 @@
              return TelegramDispatchResult(sent=False, error=message)
  
+         message_body = self._build_review_notification(evaluation)
          payload = {
              "chat_id": self.settings.telegram_boss_chat_id,
-             "text": "contract reviewed",
+             "text": message_body,
          }
          url = TELEGRAM_URL_TEMPLATE.format(token=self.settings.telegram_bot_token)
```

**Chunk 3**
Lines added: 23, lines removed: undefined

```diff
@@ -43,4 +44,27 @@
              return TelegramDispatchResult(sent=False, error=str(exc))
  
+     def _build_review_notification(self, evaluation: ChecklistEvaluation) -> str:
+         """Build the notification message with critical issues and clause counts."""
+         status_counts = evaluation.status_counts()
+         compliant_count = status_counts["‚úÖ"]
+         needs_review_count = status_counts["‚ö†Ô∏è"] + status_counts["‚ùå"]
+         critical_count = status_counts["‚ùå"]
+ 
+         message_parts = ["Boss, there is a new contract review."]
+ 
+         # Add critical issues if any
+         if critical_count > 0:
+             critical_issues = [item for item in evaluation.items if item.status == "‚ùå"]
+             if critical_issues:
+                 message_parts.append("\n‚ö†Ô∏è Critical issues found:")
+                 # Add first critical issue as bullet point
+                 first_critical = critical_issues[0]
+                 message_parts.append(f"‚Ä¢ {first_critical.description}")
+ 
+         # Add clause counts
+         message_parts.append(f"\nüìä {compliant_count} clauses compliant, {needs_review_count} need review")
+ 
+         return "\n".join(message_parts)
+ 
      async def send_summary(
          self,
```

</details>

---

<details><summary>Edit file: app/review_service.py</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -35,5 +35,5 @@
          drive_link = self.drive.upload_report(report.local_path)
          report.drive_link = drive_link
-         telegram_result = await self.notifier.notify_review_complete()
+         telegram_result = await self.notifier.notify_review_complete(evaluation=evaluation)
          return evaluation, report, drive_link, telegram_result
  
```

</details>

---



---


Updating tests to pass the evaluation parameter:


---

Read file: undefined

---



---



---


Checking for linting errors:


---



---



---


## Changes Made:

1. **Updated `app/telegram_client.py`**:
   - Modified `notify_review_complete()` to accept an `evaluation` parameter
   - Added `_build_review_notification()` that builds the message with:
     - "Boss, there is a new contract review."
     - A critical issues section (if any ‚ùå status items exist) with a bullet point showing the first critical issue
     - Clause counts showing compliant vs. needs review

2. **Updated `app/review_service.py`**:
   - Updated the call to pass the `evaluation` to `notify_review_complete()`

The Telegram message will now look like:

```
Boss, there is a new contract review.

‚ö†Ô∏è Critical issues found:
‚Ä¢ [First critical issue description]

üìä 5 clauses compliant, 3 need review
```

If there are no critical issues, it will just show:
```
Boss, there is a new contract review.

üìä 5 clauses compliant, 2 need review
```

The message includes critical issues (if any) and the clause counts as requested.

---

